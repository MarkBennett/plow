#!/usr/bin/env bash

set -e

function usage
{
  echo
  echo "$(basename $0) runs recipes on your servers"
  echo
  echo "usage: $(basename $0) [commands [--staging | --production] [--sudo]] | [--help]"
  echo
  echo "       commands           : list of recipes that you want to execute"
  echo "                          :   e.g. postgres nginx rails"
  echo "                          :   (should correspond to recipes in Plowfile)"
  echo "       --staging          : use .env.staging for configuration"
  echo "       --production       : use .env.production for configuration"
  echo "       --help             : displays the information you're reading now"
  echo "       --sudo             : run all commands as sudo"
  echo
}

recipe() {
  wget -nc -qP .plow $1
}

bail() {
  echo -e "\033[31m  failed: $1\033[0m"
  exit 1
}

info() {
  echo -e "\033[1;33m== $1\033[0m"
}

declare -a commands

source Plowfile
for i in "${RECIPES[@]}"
do
	recipe $i
done

while test $# != 0; do
  case "$1" in
    --staging|staging)
      [[ -f .env.staging ]] || bail "no .env.staging found"
      ENVIRONMENT=staging
      source .env.$ENVIRONMENT
      ;;
    --production|production)
      [[ -f .env.production ]] || bail "no .env.production found"
      ENVIRONMENT=production
      source .env.$ENVIRONMENT
      ;;
    --sudo|sudo)
      SUDO=sudo
      ;;
    --help)
      usage
      exit
      ;;
    --*)
      tmp=${1:2}
      eval ${tmp%=*}=${tmp#*=} 
      ;;
    *)
      [[ -f .plow/$1 ]] && commands[${#commands[@]}]=".plow/$1"
      ;;
  esac
  shift
done

recipe_content=$(find ${commands[@]} -type f | xargs -I % sh -c "echo ; echo 'echo '== Processing recipe: %'' ; cat %")
environment_content=$(cat .env.$ENVIRONMENT)
mkdir -p .plow && echo "$environment_content $recipe_content" > .plow/plow.sh
mkdir -p .plow/files && cp ${FILES[@]} .plow/files/

cd .plow && tar cz . | ssh $USER@$SERVER "rm -rf plow && mkdir plow && cd plow && tar xz && $SUDO bash plow.sh"
