#!/usr/bin/env bash

set -e

bail() {
  echo -e "\033[31m  failed: $1\033[0m"
  exit 1
}

info() {
  echo -e "\033[1;33m== $1\033[0m"
}

recipe() {
  wget -nc -qP .plow $1
  source .plow/$(basename "$1")
}

while test $# != 0; do
  case "$1" in
    --staging|staging)
      [[ -f .env.staging ]] || bail "no .env.staging found"
      ENVIRONMENT=staging
      source .env.staging
      ;;
    --production|production)
      [[ -f .env.production ]] || bail "no .env.production found"
      ENVIRONMENT=production
      source .env.production
      ;;
    --rev=*)
      REF="${1#--rev=}"
      ;;
    *)
      export $1=true
      ;;      
  esac
  shift
done

recipe https://gist.github.com/mm53bar/5053150/raw/ff4b353b9671fc541785860e58b9cc9dcebd0820/test
recipe https://gist.github.com/mm53bar/5053150/raw/bb9f7deb7f93b940c48e399e2629cfce8b458cc8/gitrev
recipe https://raw.github.com/mm53bar/plow/recipes/bin/deploy
recipe https://raw.github.com/mm53bar/plow/recipes/bin/migrate
recipe https://raw.github.com/mm53bar/plow/recipes/bin/start
recipe https://raw.github.com/mm53bar/plow/recipes/bin/stop
