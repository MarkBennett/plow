#!/usr/bin/env bash

set -e

recipe() {
  wget -nc -qP .plow $1
}

recipe https://gist.github.com/mm53bar/5053150/raw/ff4b353b9671fc541785860e58b9cc9dcebd0820/test
recipe https://gist.github.com/mm53bar/5053150/raw/bb9f7deb7f93b940c48e399e2629cfce8b458cc8/gitrev
recipe https://raw.github.com/mm53bar/plow/recipes/bin/deploy
recipe https://raw.github.com/mm53bar/plow/recipes/bin/migrate
recipe https://raw.github.com/mm53bar/plow/recipes/bin/start
recipe https://raw.github.com/mm53bar/plow/recipes/bin/stop
recipe https://raw.github.com/mm53bar/plow/recipes/bin/status

bail() {
  echo -e "\033[31m  failed: $1\033[0m"
  exit 1
}

info() {
  echo -e "\033[1;33m== $1\033[0m"
}

while test $# != 0; do
  case "$1" in
    --staging|staging)
      [[ -f .env.staging ]] || bail "no .env.staging found"
      source .env.staging
      recipes+=(".env.staging")
      ;;
    --production|production)
      [[ -f .env.production ]] || bail "no .env.production found"
      source .env.production
      recipes+=(".env.production")
      ;;
    --rev=*)
      REF="${1#--rev=}"
      ;;
    *)
      [[ -f .plow/$(basename $1) ]] && recipes+=(".plow/$(basename $1)")
      ;;
  esac
  shift
done

for recipe in ${recipes[@]} ; do
  recipe_content+=`cat $recipe;echo`
done
ssh $APP@$SERVER "echo '$recipe_content' > plow.sh && $sudo bash plow.sh"
